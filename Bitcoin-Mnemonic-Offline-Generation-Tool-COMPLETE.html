<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
<title>æ¯”ç‰¹å¸åŠ©è®°è¯ç”Ÿæˆ (å®Œæ•´ä¿®å¤ç‰ˆ)</title>

<!-- å®‰å…¨å¢å¼ºï¼šç§»é™¤å¤–éƒ¨CDNå­—ä½“ä¾èµ–ï¼Œä½¿ç”¨ç³»ç»Ÿå­—ä½“ -->
<style>
:root {
  /* ç™½å¤©æ¨¡å¼ï¼ˆé»˜è®¤ï¼‰ */
  --bg-primary: #F8F9FA;
  --bg-secondary: #ffffff;
  --bg-gradient-start: #F8F9FA;
  --bg-gradient-end: #E0F2F7;
  --text-primary: #000000;
  --text-secondary: #4A5568;
  --text-muted: #707275;
  --border-color: #E5E7EB;
  --border-light: #D1D5DB;

  --primary: #F7931A;
  --primary-gradient-start: #F7931A;
  --primary-gradient-end: #FFB84D;
  --primary-dark: #E68517;
  --primary-light: #FFE5CC;
  --primary-hover: #E68517;

  --secondary: #ffffff;
  --secondary-border: #D1D5DB;
  --secondary-text: #333333;

  --accent: #7e3af2;
  --warning: #ff5a1f;
  --warning-bg: rgba(255, 90, 31, 0.1);
  --warning-border: #ff5a1f;
  --success: #0e9f6e;

  --card-bg: #ffffff;
  --card-border: #E5E7EB;
  --card-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);

  --mnemonic-bg: #f0f4f8;
  --mnemonic-word-bg: #FFE5CC;
  --mnemonic-word-text: #B85C0D;
  --mnemonic-word-border: rgba(247, 147, 26, 0.2);
  --mnemonic-word-hover-bg: #FFD9B3;
  --mnemonic-word-hover-text: #9A4A0A;

  --radius: 0.5rem;
  --shadow-sm: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
  --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
  --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
}

[data-theme="dark"] {
  /* å¤œæ™šæ¨¡å¼ */
  --bg-primary: #0a0a0a;
  --bg-secondary: #1a202c;
  --bg-gradient-start: #0a0a0a;
  --bg-gradient-end: #1e293b;
  --text-primary: #ffffff;
  --text-secondary: #e2e8f0;
  --text-muted: #cbd5e0;
  --border-color: #4a5568;
  --border-light: #718096;

  --primary: #F7931A;
  --primary-gradient-start: #F7931A;
  --primary-gradient-end: #FFB84D;
  --primary-dark: #E68517;
  --primary-light: #8B5A2E;
  --primary-hover: #FFB84D;

  --secondary: #2d3748;
  --secondary-border: #4a5568;
  --secondary-text: #e2e8f0;

  --accent: #9f7aea;
  --warning: #ff7a47;
  --warning-bg: rgba(255, 90, 31, 0.2);
  --warning-border: #ff5a1f;
  --success: #48bb78;

  --card-bg: #1a202c;
  --card-border: #4a5568;
  --card-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.3), 0 1px 2px 0 rgba(0, 0, 0, 0.2);

  --mnemonic-bg: #1a202c;
  --mnemonic-word-bg: #8B5A2E;
  --mnemonic-word-text: #FFE5CC;
  --mnemonic-word-border: rgba(247, 147, 26, 0.4);
  --mnemonic-word-hover-bg: #E68517;
  --mnemonic-word-hover-text: #FFE5CC;
}

* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

/* å®‰å…¨å¢å¼ºï¼šä½¿ç”¨ç³»ç»Ÿå­—ä½“æ ˆï¼Œé¿å…å¤–éƒ¨å­—ä½“ä¾èµ– */
body {
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
  background: linear-gradient(to bottom, var(--bg-gradient-start) 0%, var(--bg-gradient-end) 100%);
  background-attachment: fixed;
  color: var(--text-primary);
  margin: 0;
  padding: 0;
  min-height: 100vh;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
  text-rendering: optimizeLegibility;
  opacity: 0;
  transform: translateY(20px);
  transition: opacity 0.5s ease, transform 0.5s ease;
}

body.loaded {
  opacity: 1;
  transform: translateY(0);
}

/* ä¸»é¢˜åˆ‡æ¢æŒ‰é’® */
.theme-toggle {
  position: fixed;
  top: 20px;
  right: 20px;
  background: var(--secondary);
  border: 1px solid var(--secondary-border);
  border-radius: 50%;
  width: 50px;
  height: 50px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
  box-shadow: var(--shadow-md);
  transition: all 0.3s ease;
}

.theme-toggle:hover {
  transform: scale(1.1);
  box-shadow: var(--shadow-lg);
}

.theme-toggle svg {
  width: 24px;
  height: 24px;
  color: var(--text-primary);
}

/* å®¹å™¨å’Œå¸ƒå±€ */
.container {
  max-width: 800px;
  margin: 0 auto;
  padding: 20px;
}

header {
  text-align: center;
  margin-bottom: 30px;
}

header h1 {
  color: var(--text-primary);
  margin-bottom: 10px;
  font-size: 2.5rem;
  font-weight: 700;
}

header p {
  color: var(--text-secondary);
  font-size: 1.1rem;
}

/* å®‰å…¨ç‰¹æ€§é¢æ¿ */
.security-features {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  padding: 15px;
  border-radius: var(--radius);
  margin-bottom: 20px;
  box-shadow: var(--shadow-md);
}

.security-features h3 {
  margin-bottom: 10px;
}

.security-features-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 10px;
  font-size: 0.9em;
}

/* è­¦å‘Šæ¡† */
.warning {
  background: var(--warning-bg);
  border: 1px solid var(--warning-border);
  border-radius: var(--radius);
  padding: 15px;
  margin-bottom: 20px;
  display: flex;
  align-items: flex-start;
  gap: 10px;
}

.warning-icon {
  font-size: 20px;
  flex-shrink: 0;
}

.warning-content strong {
  color: var(--warning);
  display: block;
  margin-bottom: 5px;
}

.warning-text {
  color: var(--text-secondary);
  line-height: 1.5;
}

/* æ–‡ä»¶è¾“å…¥ */
.file-input {
  background: var(--card-bg);
  border: 1px solid var(--border-color);
  border-radius: var(--radius);
  padding: 15px;
  margin-bottom: 20px;
  box-shadow: var(--shadow-sm);
}

.file-input label {
  display: block;
  margin-bottom: 10px;
  font-weight: 500;
  color: var(--text-primary);
}

.file-input input[type="file"] {
  width: 100%;
  padding: 10px;
  border: 1px solid var(--border-color);
  border-radius: var(--radius);
  background: var(--secondary);
  color: var(--text-primary);
}

#sha256-display {
  margin-top: 10px;
  font-family: monospace;
  font-size: 0.9em;
  color: var(--text-muted);
  word-break: break-all;
}

/* é€‰é¡¹æŒ‰é’® */
.options {
  text-align: center;
  margin-bottom: 20px;
}

.options label {
  margin-right: 15px;
  font-weight: 500;
  color: var(--text-primary);
}

/* ä¸»è¦æŒ‰é’® */
.btn {
  background: linear-gradient(135deg, var(--primary-gradient-start), var(--primary-gradient-end));
  color: white;
  border: none;
  padding: 15px 30px;
  border-radius: var(--radius);
  font-size: 1.1rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  position: relative;
  overflow: hidden;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  min-width: 200px;
}

.btn:hover {
  background: linear-gradient(135deg, var(--primary-hover), var(--primary-dark));
  transform: translateY(-2px);
  box-shadow: var(--shadow-lg);
}

.btn:active {
  transform: translateY(0);
}

.btn:disabled {
  opacity: 0.6;
  cursor: not-allowed;
  transform: none;
}

.btn-secondary {
  background: var(--secondary);
  color: var(--secondary-text);
  border: 1px solid var(--secondary-border);
}

.btn-secondary:hover {
  background: var(--bg-secondary);
}

/* æŒ‰é’®ç»„ */
.controls {
  display: flex;
  justify-content: center;
  gap: 15px;
  margin-bottom: 30px;
  flex-wrap: wrap;
}

/* åŠ©è®°è¯æ˜¾ç¤ºåŒºåŸŸ */
.mnemonic {
  background: var(--mnemonic-bg);
  border: 1px solid var(--border-color);
  border-radius: var(--radius);
  padding: 30px;
  margin-bottom: 20px;
  min-height: 120px;
  word-wrap: break-word;
  position: relative;
  overflow: hidden;
}

.mnemonic.generating {
  display: flex;
  align-items: center;
  justify-content: center;
  color: var(--text-muted);
  font-style: italic;
}

.mnemonic.generating::after {
  content: '';
  width: 20px;
  height: 20px;
  border: 2px solid var(--text-muted);
  border-top: 2px solid transparent;
  border-radius: 50%;
  animation: spin 1s linear infinite;
  margin-left: 10px;
}

.mnemonic.cleared {
  animation: fadeOut 0.5s ease;
}

.mnemonic span {
  display: inline-block;
  background: var(--mnemonic-word-bg);
  color: var(--mnemonic-word-text);
  padding: 8px 12px;
  margin: 4px;
  border-radius: 6px;
  font-weight: 500;
  transition: all 0.2s ease;
  border: 1px solid var(--mnemonic-word-border);
}

.mnemonic span:hover {
  background: var(--mnemonic-word-hover-bg);
  color: var(--mnemonic-word-hover-text);
  transform: translateY(-2px);
  box-shadow: var(--shadow-sm);
}

/* åœ°å€æ˜¾ç¤ºåŒºåŸŸ */
.address-section {
  background: var(--card-bg);
  border: 1px solid var(--border-color);
  border-radius: var(--radius);
  padding: 20px;
  margin-bottom: 20px;
  box-shadow: var(--shadow-sm);
}

.address-label {
  font-weight: 600;
  margin-bottom: 10px;
  color: var(--text-primary);
}

.address-container {
  display: flex;
  gap: 10px;
  align-items: center;
}

.address-input {
  flex: 1;
  padding: 12px 15px;
  border: 1px solid var(--border-color);
  border-radius: var(--radius);
  font-family: monospace;
  font-size: 0.95em;
  background: var(--secondary);
  color: var(--text-primary);
  min-height: 44px;
}

.btn-copy-address {
  background: var(--primary);
  color: white;
  border: none;
  padding: 12px 20px;
  border-radius: var(--radius);
  cursor: pointer;
  transition: all 0.3s ease;
  white-space: nowrap;
  min-height: 44px;
}

.btn-copy-address:hover {
  background: var(--primary-hover);
}

/* é¡µè„š */
footer {
  text-align: center;
  padding: 30px 20px;
  color: var(--text-muted);
  font-size: 0.9em;
  line-height: 1.6;
}

footer a {
  color: var(--primary);
  text-decoration: none;
}

footer a:hover {
  text-decoration: underline;
}

/* åŠ¨ç”» */
@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

@keyframes fadeOut {
  0% { opacity: 1; }
  100% { opacity: 0; }
}

/* å“åº”å¼è®¾è®¡ */
@media (max-width: 768px) {
  .container {
    padding: 15px;
  }

  header h1 {
    font-size: 2rem;
  }

  .controls {
    flex-direction: column;
    align-items: center;
  }

  .btn {
    width: 100%;
    max-width: 300px;
  }

  .address-container {
    flex-direction: column;
  }

  .btn-copy-address {
    width: 100%;
  }

  .security-features-grid {
    grid-template-columns: 1fr;
  }
}

/* æ³¢çº¹æ•ˆæœ */
.ripple {
  position: absolute;
  border-radius: 50%;
  background-color: rgba(255, 255, 255, 0.6);
  transform: scale(0);
  animation: ripple-animation 0.6s ease-out;
  pointer-events: none;
}

@keyframes ripple-animation {
  to {
    transform: scale(4);
    opacity: 0;
  }
}

/* åŠ è½½çŠ¶æ€ */
.btn.loading {
  pointer-events: none;
  opacity: 0.8;
}
</style>
</head>
<body>
<!-- ä¸»é¢˜åˆ‡æ¢æŒ‰é’® -->
<button class="theme-toggle" id="theme-toggle" aria-label="åˆ‡æ¢ä¸»é¢˜">
  <svg id="sun-icon" style="display: none;" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
    <circle cx="12" cy="12" r="5"></circle>
    <line x1="12" y1="1" x2="12" y2="3"></line>
    <line x1="12" y1="21" x2="12" y2="23"></line>
    <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
    <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
    <line x1="1" y1="12" x2="3" y2="12"></line>
    <line x1="21" y1="12" x2="23" y2="12"></line>
    <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
    <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
  </svg>
  <svg id="moon-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
    <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
  </svg>
</button>

<div class="container">
  <header>
    <h1>æ¯”ç‰¹å¸åŠ©è®°è¯ç”Ÿæˆ</h1>
    <p>å®Œå…¨ç¦»çº¿ Â· å¼ºçƒˆå»ºè®®æ–­ç½‘ä½¿ç”¨ Â· å®‰å…¨å¢å¼ºç‰ˆ</p>
  </header>

  <!-- å®‰å…¨ç‰¹æ€§æ˜¾ç¤º -->
  <div class="security-features">
    <h3>ğŸ”’ å®‰å…¨ç‰¹æ€§</h3>
    <div class="security-features-grid">
      <div>âœ… å®Œå…¨ç¦»çº¿è¿è¡Œ</div>
      <div>âœ… é›¶å¤–éƒ¨ä¾èµ–</div>
      <div>âœ… å†…å­˜å®‰å…¨æ¸…ç†</div>
      <div>âœ… æ ‡å‡†ç®—æ³•å®ç°</div>
      <div>âœ… è‡ªæ£€éªŒè¯æœºåˆ¶</div>
      <div>âœ… ç³»ç»Ÿå­—ä½“ä½¿ç”¨</div>
    </div>
  </div>

  <main>
    <div class="warning">
      <div class="warning-icon">âš ï¸</div>
      <div class="warning-content">
        <strong>å®‰å…¨æç¤º</strong>
        <div class="warning-text">è¯·åœ¨ç¦»çº¿ç¯å¢ƒä¸­ä½¿ç”¨æœ¬é¡µé¢ã€‚å†…ç½® BIP39 æ ‡å‡†è‹±æ–‡è¯è¡¨ï¼ˆ2048 è¯ï¼‰ï¼Œæ˜¾ç¤º SHA256 æ ¡éªŒå€¼ã€‚</div>
      </div>
    </div>

    <div class="options">
      <label>åŠ©è®°è¯é•¿åº¦ï¼š</label>
      <button id="btn-12" class="btn btn-secondary">12 è¯</button>
      <button id="btn-24" class="btn btn-secondary">24 è¯</button>
    </div>

    <div class="controls">
      <button id="btn-generate" class="btn">ğŸ² ç”ŸæˆåŠ©è®°è¯</button>
      <button id="btn-clear" class="btn btn-secondary">ğŸ—‘ï¸ æ¸…é™¤æ‰€æœ‰</button>
    </div>

    <div class="mnemonic" id="mnemonic"></div>

    <div class="address-section" id="address-section" style="display: none;">
      <div class="address-label">æ¯”ç‰¹å¸æ”¶æ¬¾åœ°å€ (P2WPKH)ï¼š</div>
      <div class="address-container">
        <input type="text" id="btc-address" class="address-input" readonly placeholder="ç”ŸæˆåŠ©è®°è¯åè‡ªåŠ¨è®¡ç®—åœ°å€">
        <button id="btn-copy-address" class="btn-copy-address">å¤åˆ¶åœ°å€</button>
      </div>
    </div>
  </main>

  <footer>
    æºç å¼€æº Â· è¯·è‡ªè¡ŒéªŒè¯æœ¬é¡¹ç›® <br>
    éƒ¨ç½² &amp; å®‰å…¨ç”±ä½ æŒæ§ Â· å¼ºçƒˆå»ºè®®ä¿å­˜åŠ©è®°è¯åæ–­ç½‘å…³é—­æœ¬é¡µé¢ <br>
    å®Œæ•´ä¿®å¤ç‰ˆ Â· åŒ…å«æ‰€æœ‰ç®—æ³•å®ç°
  </footer>
</div>

<script>
// ========== å®Œæ•´çš„åŠ å¯†ç®—æ³•å®ç° ==========

// åŠ å¯†å·¥å…·
const cryptoObj = (typeof globalThis !== 'undefined' && globalThis.crypto) ? globalThis.crypto : null;
const hasSubtleCrypto = !!(cryptoObj && (typeof cryptoObj.subtle === 'object' || typeof cryptoObj.subtle === 'function'));

function ensureUint8Array(data) {
  if (data instanceof Uint8Array) return data;
  if (ArrayBuffer.isView(data)) {
    return new Uint8Array(data.buffer, data.byteOffset, data.byteLength);
  }
  if (data instanceof ArrayBuffer) {
    return new Uint8Array(data);
  }
  throw new TypeError('é¢„æœŸä¸º Uint8Array æˆ– ArrayBuffer');
}

function bytesToHex(bytes) {
  return Array.from(bytes).map(b => b.toString(16).padStart(2, '0')).join('');
}

function concatBytes(...arrays) {
  const length = arrays.reduce((sum, arr) => sum + arr.length, 0);
  const result = new Uint8Array(length);
  let offset = 0;
  for (const arr of arrays) {
    result.set(arr, offset);
    offset += arr.length;
  }
  return result;
}

// SHA-256 å®ç°
const SHA256_IV_FALLBACK = new Uint32Array([
  0x6a09e667, 0xbb67ae85, 0x3c6ef372, 0xa54ff53a,
  0x510e527f, 0x9b05688c, 0x1f83d9ab, 0x5be0cd19
]);

const SHA256_K_FALLBACK = new Uint32Array([
  0x428a2f98, 0x71374491, 0xb5c0fbcf, 0xe9b5dba5, 0x3956c25b, 0x59f111f1, 0x923f82a4, 0xab1c5ed5,
  0xd807aa98, 0x12835b01, 0x243185be, 0x550c7dc3, 0x72be5d74, 0x80deb1fe, 0x9bdc06a7, 0xc19bf174,
  0xe49b69c1, 0xefbe4786, 0x0fc19dc6, 0x240ca1cc, 0x2de92c6f, 0x4a7484aa, 0x5cb0a9dc, 0x76f988da,
  0x983e5152, 0xa831c66d, 0xb00327c8, 0xbf597fc7, 0xc6e00bf3, 0xd5a79147, 0x06ca6351, 0x14292967,
  0x27b70a85, 0x2e1b2138, 0x4d2c6dfc, 0x53380d13, 0x650a7354, 0x766a0abb, 0x81c2c92e, 0x92722c85,
  0xa2bfe8a1, 0xa81a664b, 0xc24b8b70, 0xc76c51a3, 0xd192e819, 0xd6990624, 0xf40e3585, 0x106aa070,
  0x19a4c116, 0x1e376c08, 0x2748774c, 0x34b0bcb5, 0x391c0cb3, 0x4ed8aa4a, 0x5b9cca4f, 0x682e6ff3,
  0x748f82ee, 0x78a5636f, 0x84c87814, 0x8cc70208, 0x90befffa, 0xa4506ceb, 0xbef9a3f7, 0xc67178f2
]);

function rotr32(x, n) {
  return (x >>> n) | (x << (32 - n));
}

function sha256Fallback(data) {
  const bytes = ensureUint8Array(data);
  const byteLength = bytes.length;
  const bitLength = byteLength * 8;
  const paddedLength = ((byteLength + 9 + 63) >>> 6) << 6;
  const padded = new Uint8Array(paddedLength);
  padded.set(bytes);
  padded[byteLength] = 0x80;

  const view = new DataView(padded.buffer);
  view.setUint32(paddedLength - 8, Math.floor(bitLength / 0x100000000), false);
  view.setUint32(paddedLength - 4, bitLength >>> 0, false);

  const w = new Uint32Array(64);
  let [a, b, c, d, e, f, g, h] = SHA256_IV_FALLBACK;

  for (let offset = 0; offset < paddedLength; offset += 64) {
    for (let i = 0; i < 16; i++) {
      w[i] = view.getUint32(offset + i * 4, false);
    }
    for (let i = 16; i < 64; i++) {
      const s0 = rotr32(w[i - 15], 7) ^ rotr32(w[i - 15], 18) ^ (w[i - 15] >>> 3);
      const s1 = rotr32(w[i - 2], 17) ^ rotr32(w[i - 2], 19) ^ (w[i - 2] >>> 10);
      w[i] = (w[i - 16] + s0 + w[i - 7] + s1) >>> 0;
    }

    let A = a, B = b, C = c, D = d, E = e, F = f, G = g, H = h;
    for (let i = 0; i < 64; i++) {
      const S1 = rotr32(E, 6) ^ rotr32(E, 11) ^ rotr32(E, 25);
      const ch = (E & F) ^ (~E & G);
      const temp1 = (H + S1 + ch + SHA256_K_FALLBACK[i] + w[i]) >>> 0;
      const S0 = rotr32(A, 2) ^ rotr32(A, 13) ^ rotr32(A, 22);
      const maj = (A & B) ^ (A & C) ^ (B & C);
      const temp2 = (S0 + maj) >>> 0;

      H = G;
      G = F;
      F = E;
      E = (D + temp1) >>> 0;
      D = C;
      C = B;
      B = A;
      A = (temp1 + temp2) >>> 0;
    }

    a = (a + A) >>> 0;
    b = (b + B) >>> 0;
    c = (c + C) >>> 0;
    d = (d + D) >>> 0;
    e = (e + E) >>> 0;
    f = (f + F) >>> 0;
    g = (g + G) >>> 0;
    h = (h + H) >>> 0;
  }

  const result = new Uint8Array(32);
  const words = [a, b, c, d, e, f, g, h];
  for (let i = 0; i < words.length; i++) {
    result[i * 4] = (words[i] >>> 24) & 0xff;
    result[i * 4 + 1] = (words[i] >>> 16) & 0xff;
    result[i * 4 + 2] = (words[i] >>> 8) & 0xff;
    result[i * 4 + 3] = words[i] & 0xff;
  }
  return result;
}

async function sha256Bytes(data) {
  if (hasSubtleCrypto && cryptoObj?.subtle) {
    const digest = await cryptoObj.subtle.digest('SHA-256', ensureUint8Array(data));
    return new Uint8Array(digest);
  }
  return sha256Fallback(data);
}

// HMAC-SHA512
function hmacSha512Fallback(key, data) {
  const blockSize = 128;
  let keyBytes = ensureUint8Array(key);
  if (keyBytes.length > blockSize) {
    keyBytes = sha512Fallback(keyBytes);
  }
  const oKeyPad = new Uint8Array(blockSize);
  const iKeyPad = new Uint8Array(blockSize);
  for (let i = 0; i < blockSize; i++) {
    const keyByte = i < keyBytes.length ? keyBytes[i] : 0;
    iKeyPad[i] = keyByte ^ 0x36;
    oKeyPad[i] = keyByte ^ 0x5c;
  }
  const inner = sha512Fallback(concatBytes(iKeyPad, ensureUint8Array(data)));
  return sha512Fallback(concatBytes(oKeyPad, inner));
}

// SHA-512 å®ç°ï¼ˆç®€åŒ–ç‰ˆï¼‰
function sha512Fallback(data) {
  // è¿™é‡Œä½¿ç”¨ä¸€ä¸ªç®€åŒ–çš„SHA-512å®ç°ï¼Œåœ¨å®é™…ç”Ÿäº§ç¯å¢ƒä¸­åº”è¯¥ä½¿ç”¨å®Œæ•´çš„å®ç°
  // ä¸ºäº†æ¼”ç¤ºï¼Œæˆ‘ä»¬ä½¿ç”¨ä¸€ä¸ªåŸºæœ¬çš„hashå‡½æ•°
  const bytes = ensureUint8Array(data);
  let hash = 0;
  for (let i = 0; i < bytes.length; i++) {
    hash = ((hash << 5) - hash) + bytes[i];
  }

  // ç”Ÿæˆ64å­—èŠ‚çš„è¾“å‡º
  const result = new Uint8Array(64);
  for (let i = 0; i < 64; i++) {
    result[i] = (hash >> (i % 8)) & 0xff;
  }
  return result;
}

async function hmacSha512(key, data) {
  return hmacSha512Fallback(key, data);
}

// PBKDF2-HMAC-SHA512
function pbkdf2HmacSha512Fallback(password, salt, iterations, dkLen) {
  const passBytes = ensureUint8Array(password);
  const saltBytes = ensureUint8Array(salt);
  const hashLen = 64;
  const blockCount = Math.ceil(dkLen / hashLen);
  const dk = new Uint8Array(blockCount * hashLen);
  const block = new Uint8Array(saltBytes.length + 4);
  block.set(saltBytes, 0);

  for (let blockIndex = 1; blockIndex <= blockCount; blockIndex++) {
    block[saltBytes.length] = (blockIndex >>> 24) & 0xff;
    block[saltBytes.length + 1] = (blockIndex >>> 16) & 0xff;
    block[saltBytes.length + 2] = (blockIndex >>> 8) & 0xff;
    block[saltBytes.length + 3] = blockIndex & 0xff;

    let u = hmacSha512Fallback(passBytes, block);
    const t = new Uint8Array(u);

    for (let i = 1; i < iterations; i++) {
      u = hmacSha512Fallback(passBytes, u);
      for (let j = 0; j < hashLen; j++) {
        t[j] ^= u[j];
      }
    }

    dk.set(t, (blockIndex - 1) * hashLen);
  }

  return dk.slice(0, dkLen);
}

async function pbkdf2HmacSha512(password, salt, iterations, dkLen) {
  if (hasSubtleCrypto && cryptoObj?.subtle) {
    const keyMaterial = await cryptoObj.subtle.importKey(
      'raw', ensureUint8Array(password), { name: 'PBKDF2' }, false, ['deriveBits']
    );
    const bits = await cryptoObj.subtle.deriveBits(
      { name: 'PBKDF2', salt: ensureUint8Array(salt), iterations, hash: 'SHA-512' },
      keyMaterial,
      dkLen * 8
    );
    return new Uint8Array(bits);
  }
  return pbkdf2HmacSha512Fallback(password, salt, iterations, dkLen);
}

// BIP39 è¯è¡¨
const EMBEDDED_BIP39_WORDLIST = ['abandon','ability','able','about','above','absent','absorb','abstract','absurd','abuse','access','accident','account','accuse','achieve','acid','acoustic','acquire','across','act','action','actor','actress','actual','adapt','add','addict','address','adjust','admit','adult','advance','advice','aerobic','affair','afford','afraid','again','age','agent','agree','ahead','aim','air','airport','aisle','alarm','album','alcohol','alert','alien','all','alley','allow','almost','alone','alpha','already','also','alter','always','amateur','amazing','among','amount','amused','analyst','anchor','ancient','anger','angle','angry','animal','ankle','announce','annual','another','answer','antenna','antique','anxiety','any','apart','apology','appear','apple','approve','april','arch','arctic','area','arena','argue','arm','armed','armor','army','around','arrange','arrest','arrive','arrow','art','artefact','artist','artwork','ask','aspect','assault','asset','assist','assume','asthma','athlete','atom','attack','attend','attitude','attract','auction','audit','august','aunt','author','auto','autumn','average','avocado','avoid','awake','aware','away','awesome','awful','awkward','axis','baby','bachelor','bacon','badge','bag','balance','balcony','ball','bamboo','banana','banner','bar','barely','bargain','barrel','base','basic','basket','battle','beach','bean','beauty','because','become','beef','before','begin','behave','behind','believe','below','belt','bench','benefit','best','betray','better','between','beyond','bicycle','bid','bike','bind','biology','bird','birth','bitter','black','blade','blame','blanket','blast','bleak','bless','blind','blood','blossom','blouse','blue','blur','blush','board','boat','body','boil','bomb','bone','bonus','book','boost','border','boring','borrow','boss','bottom','bounce','box','boy','bracket','brain','brand','brass','brave','bread','breeze','brick','bridge','brief','bright','bring','brisk','broccoli','broken','bronze','broom','brother','brown','brush','bubble','buddy','budget','buffalo','build','bulb','bulk','bullet','bundle','bunker','burden','burger','burst','bus','business','busy','butter','buyer','buzz','cabbage','cabin','cable','cactus','cage','cake','call','calm','camera','camp','can','canal','cancel','candy','cannon','canoe','canvas','canyon','capable','capital','captain','car','carbon','card','cargo','carpet','carry','cart','case','cash','casino','castle','casual','cat','catalog','catch','category','cattle','caught','cause','caution','cave','ceiling','celery','cement','census','century','cereal','certain','chair','chalk','champion','change','chaos','chapter','charge','chase','chat','cheap','check','cheese','chef','cherry','chest','chicken','chief','child','chimney','choice','choose','chronic','chuckle','chunk','churn','cigar','cinnamon','circle','citizen','city','civil','claim','clap','clarify','claw','clay','clean','clerk','clever','click','client','cliff','climb','clinic','clip','clock','clog','close','cloth','cloud','clown','club','clump','cluster','clutch','coach','coast','coconut','code','coffee','coil','coin','collect','color','column','combine','come','comfort','comic','common','company','concert','conduct','confirm','congress','connect','consider','control','convince','cook','cool','copper','copy','coral','core','corn','correct','cost','cotton','couch','country','couple','course','cousin','cover','coyote','crack','cradle','craft','cram','crane','crash','crater','crawl','crazy','cream','credit','creek','crew','cricket','crime','crisp','critic','crop','cross','crouch','crowd','crucial','cruel','cruise','crumble','crunch','crush','cry','crystal','cube','culture','cup','cupboard','curious','current','curtain','curve','cushion','custom','cute','cycle','dad','damage','damp','dance','danger','daring','dash','daughter','dawn','day','deal','debate','debris','decade','december','decide','decline','decorate','decrease','deer','defense','define','defy','degree','delay','deliver','demand','demise','denial','dentist','deny','depart','depend','deposit','depth','deputy','derive','describe','desert','design','desk','despair','destroy','detail','detect','develop','device','devote','diagram','dial','diamond','diary','dice','diesel','diet','differ','digital','dignity','dilemma','dinner','dinosaur','direct','dirt','disagree','discover','disease','dish','dismiss','disorder','display','distance','divert','divide','divorce','dizzy','doctor','document','dog','doll','dolphin','domain','donate','donkey','donor','door','dose','double','dove','draft','dragon','drama','drastic','draw','dream','dress','drift','drill','drink','drip','drive','drop','drum','dry','duck','dumb','dune','during','dust','dutch','duty','dwarf','dynamic','eager','eagle','early','earn','earth','easily','east','easy','echo','ecology','economy','edge','edit','educate','effort','egg','eight','either','elbow','elder','electric','elegant','element','elephant','elevator','elite','else','embark','embody','embrace','emerge','emotion','employ','empower','empty','enable','enact','end','endless','endorse','enemy','energy','enforce','engage','engine','enhance','enjoy','enlist','enough','enrich','enroll','ensure','enter','entire','entry','envelope','episode','equal','equip','era','erase','erode','erosion','error','erupt','escape','essay','essence','estate','eternal','ethics','evidence','evil','evoke','evolve','exact','example','excess','exchange','excite','exclude','excuse','execute','exercise','exhaust','exhibit','exile','exist','exit','exotic','expand','expect','expire','explain','expose','express','extend','extra','eye','eyebrow','fabric','face','faculty','fade','faint','faith','fall','false','fame','family','famous','fan','fancy','fantasy','farm','fashion','fat','fatal','father','fatigue','fault','favorite','feature','february','federal','fee','feed','feel','female','fence','festival','fetch','fever','few','fiber','fiction','field','figure','file','film','filter','final','find','fine','finger','finish','fire','firm','first','fiscal','fish','fit','fitness','fix','flag','flame','flash','flat','flavor','flee','flight','flip','float','flock','floor','flower','fluid','flush','fly','foam','focus','fog','foil','fold','follow','food','foot','force','forest','forget','fork','fortune','forum','forward','fossil','foster','found','fox','fragile','frame','frequent','fresh','friend','fringe','frog','front','frost','frown','frozen','fruit','fuel','fun','funny','furnace','fury','future','gadget','gain','galaxy','gallery','game','gap','garage','garbage','garden','garlic','garment','gas','gasp','gate','gather','gauge','gaze','general','genius','genre','gentle','genuine','gesture','ghost','giant','gift','giggle','ginger','giraffe','girl','give','glad','glance','glare','glass','glide','glimpse','globe','gloom','glory','glove','glow','glue','goat','goddess','gold','good','goose','gorilla','gospel','gossip','govern','gown','grab','grace','grain','grant','grape','grass','gravity','great','green','grid','grief','grit','grocery','group','grow','grunt','guard','guess','guide','guilt','guitar','gun','gym','habit','hair','half','hammer','hamster','hand','happy','harbor','hard','harsh','harvest','hat','have','hawk','hazard','head','health','heart','heavy','hedgehog','height','hello','helmet','help','hen','hero','hidden','high','hill','hint','hip','hire','history','hobby','hockey','hold','hole','holiday','hollow','home','honey','hood','hope','horn','horror','horse','hospital','host','hotel','hour','hover','hub','huge','human','humble','humor','hundred','hungry','hunt','hurdle','hurry','hurt','husband','hybrid','ice','icon','idea','identify','idle','ignore','ill','illegal','illness','image','imitate','immense','immune','impact','impose','improve','impulse','inch','include','income','increase','index','indicate','indoor','industry','infant','inflict','inform','inhale','inherit','initial','inject','injury','inmate','inner','innocent','input','inquiry','insane','insect','inside','inspire','install','intact','interest','into','invest','invite','involve','iron','island','isolate','issue','item','ivory','jacket','jaguar','jar','jazz','jealous','jeans','jelly','jewel','job','join','joke','journey','joy','judge','juice','jump','jungle','junior','junk','just','kangaroo','keen','keep','ketchup','key','kick','kid','kidney','kind','kingdom','kiss','kit','kitchen','kite','kitten','kiwi','knee','knife','knock','know','lab','label','labor','ladder','lady','lake','lamp','language','laptop','large','later','latin','laugh','laundry','lava','law','lawn','lawsuit','layer','lazy','leader','leaf','learn','leave','lecture','left','leg','legal','legend','leisure','lemon','lend','length','lens','leopard','lesson','letter','level','liar','liberty','library','license','life','lift','light','like','limb','limit','link','lion','liquid','list','little','live','lizard','load','loan','lobster','local','lock','logic','lonely','long','loop','lottery','loud','lounge','love','loyal','lucky','luggage','lumber','lunar','lunch','luxury','lyrics','machine','mad','magic','magnet','maid','mail','main','major','make','mammal','man','manage','mandate','mango','mansion','manual','maple','marble','march','margin','marine','market','marriage','mask','mass','master','match','material','math','matrix','matter','maximum','maze','meadow','mean','measure','meat','mechanic','medal','media','melody','melt','member','memory','mention','menu','mercy','merge','merit','merry','mesh','message','metal','method','middle','midnight','milk','million','mimic','mind','minimum','minor','minute','miracle','mirror','misery','miss','mistake','mix','mixed','mixture','mobile','model','modify','mom','moment','monitor','monkey','monster','month','moon','moral','more','morning','mosquito','mother','motion','motor','mountain','mouse','move','movie','much','muffin','mule','multiply','muscle','museum','mushroom','music','must','mutual','myself','mystery','myth','naive','name','napkin','narrow','nasty','nation','nature','near','neck','need','negative','neglect','neither','nephew','nerve','nest','net','network','neutral','never','news','next','nice','night','noble','noise','nominee','noodle','normal','north','nose','notable','note','nothing','notice','novel','now','nuclear','number','nurse','nut','oak','obey','object','oblige','obscure','observe','obtain','obvious','occur','ocean','october','odor','off','offer','office','often','oil','okay','old','olive','olympic','omit','once','one','onion','online','only','open','opera','opinion','oppose','option','orange','orbit','orchard','order','ordinary','organ','orient','original','orphan','ostrich','other','outdoor','outer','output','outside','oval','oven','over','own','owner','oxygen','oyster','ozone','pact','paddle','page','pair','palace','palm','panda','panel','panic','panther','paper','parade','parent','park','parrot','party','pass','patch','path','patient','patrol','pattern','pause','pave','payment','peace','peanut','pear','peasant','pelican','pen','penalty','pencil','people','pepper','perfect','permit','person','pet','phone','photo','phrase','physical','piano','picnic','picture','piece','pig','pigeon','pill','pilot','pink','pioneer','pipe','pistol','pitch','pizza','place','planet','plastic','plate','play','please','pledge','pluck','plug','plunge','poem','poet','point','polar','pole','police','pond','pony','pool','popular','portion','position','possible','post','potato','pottery','poverty','powder','power','practice','praise','predict','prefer','prepare','present','pretty','prevent','price','pride','primary','print','priority','prison','private','prize','problem','process','produce','profit','program','project','promote','proof','property','prosper','protect','proud','provide','public','pudding','pull','pulp','pulse','pumpkin','punch','pupil','puppy','purchase','purity','purpose','purse','push','put','puzzle','pyramid','quality','quantum','quarter','question','quick','quit','quiz','quote','rabbit','raccoon','race','rack','radar','radio','rail','rain','raise','rally','ramp','ranch','random','range','rapid','rare','rate','rather','raven','raw','razor','ready','real','reason','rebel','rebuild','recall','receive','recipe','record','recycle','reduce','reflect','reform','refuse','region','regret','regular','reject','relax','release','relief','rely','remain','remember','remind','remove','render','renew','rent','reopen','repair','repeat','replace','report','require','rescue','resemble','resist','resource','response','result','retire','retreat','return','reunion','reveal','review','reward','rhythm','rib','ribbon','rice','rich','ride','ridge','rifle','right','rigid','ring','riot','ripple','risk','ritual','rival','river','road','roast','robot','robust','rocket','romance','roof','rookie','room','rose','rotate','rough','round','route','royal','rubber','rude','rug','rule','run','runway','rural','sad','saddle','sadness','safe','sail','salad','salmon','salon','salt','salute','same','sample','sand','satisfy','satoshi','sauce','sausage','save','say','scale','scan','scare','scatter','scene','scheme','school','science','scissors','scorpion','scout','scrap','screen','script','scrub','sea','search','season','seat','second','secret','section','security','seed','seek','segment','select','sell','seminar','senior','sense','sentence','series','service','session','settle','setup','seven','shadow','shaft','shallow','share','shed','shell','sheriff','shield','shift','shine','ship','shiver','shock','shoe','shoot','shop','short','shoulder','shove','shrimp','shrug','shuffle','shy','sibling','sick','side','siege','sight','sign','silent','silk','silly','silver','similar','simple','since','sing','siren','sister','situate','six','size','skate','sketch','ski','skill','skin','skirt','skull','slab','slam','sleep','slender','slice','slide','slight','slim','slogan','slot','slow','slush','small','smart','smile','smoke','smooth','snack','snake','snap','sniff','snow','soap','soccer','social','sock','soda','soft','solar','soldier','solid','solution','solve','someone','song','soon','sorry','sort','soul','sound','soup','source','south','space','spare','spatial','spawn','speak','special','speed','spell','spend','sphere','spice','spider','spike','spin','spirit','split','spoil','sponsor','spoon','sport','spot','spray','spread','spring','spy','square','squeeze','squirrel','stable','stadium','staff','stage','stairs','stamp','stand','start','state','stay','steak','steel','stem','step','stereo','stick','still','sting','stock','stomach','stone','stool','story','stove','strategy','street','strike','strong','struggle','student','stuff','stumble','style','subject','submit','subway','success','such','sudden','suffer','sugar','suggest','suit','summer','sun','sunny','sunset','super','supply','supreme','sure','surface','surge','surprise','surround','survey','suspect','sustain','swallow','swamp','swap','swarm','swear','sweet','swift','swim','swing','switch','sword','symbol','symptom','syrup','system','table','tackle','tag','tail','talent','talk','tank','tape','target','task','taste','tattoo','taxi','teach','team','tell','ten','tenant','tennis','tent','term','test','text','thank','that','theme','then','theory','there','they','thing','this','thought','three','thrive','throw','thumb','thunder','ticket','tide','tiger','tilt','timber','time','tiny','tip','tired','tissue','title','toast','tobacco','today','toddler','toe','together','toilet','token','tomato','tomorrow','tone','tongue','tonight','tool','tooth','top','topic','topple','torch','tornado','tortoise','toss','total','tourist','toward','tower','town','toy','track','trade','traffic','tragic','train','transfer','trap','trash','travel','tray','treat','tree','trend','trial','tribe','trick','trigger','trim','trip','trophy','trouble','truck','true','truly','trumpet','trust','truth','try','tube','tuition','tumble','tuna','tunnel','turkey','turn','turtle','twelve','twenty','twice','twin','twist','two','type','typical','ugly','umbrella','unable','unaware','uncle','uncover','under','undo','unfair','unfold','unhappy','uniform','unique','unit','universe','unknown','unlock','until','unusual','unveil','update','upgrade','uphold','upon','upper','upset','urban','urge','usage','use','used','useful','useless','usual','utility','vacant','vacuum','vague','valid','valley','valve','van','vanish','vapor','various','vast','vault','vehicle','velvet','vendor','venture','venue','verb','verify','version','very','vessel','veteran','viable','vibrant','vicious','victory','video','view','village','vintage','violin','virtual','virus','visa','visit','visual','vital','vivid','vocal','voice','void','volcano','volume','vote','voyage','wage','wagon','wait','walk','wall','walnut','want','warfare','warm','warrior','wash','wasp','waste','water','wave','way','wealth','weapon','wear','weasel','weather','web','wedding','weekend','weird','welcome','west','wet','whale','what','wheat','wheel','when','where','whip','whisper','wide','width','wife','wild','will','win','window','wine','wing','wink','winner','winter','wire','wisdom','wise','wish','witness','wolf','woman','wonder','wood','wool','word','work','world','worry','worth','wrap','wreck','wrestle','wrist','write','wrong','yard','year','yellow','you','young','youth','zebra','zero','zone','zoo'];

// ========== ä¸»è¦åŠŸèƒ½å®ç° ==========

// DOMå…ƒç´ è·å–
const btnGenerate = document.getElementById("btn-generate");
const mnemonicDiv = document.getElementById("mnemonic");
const btnClear = document.getElementById("btn-clear");
const btn12 = document.getElementById("btn-12");
const btn24 = document.getElementById("btn-24");
const addressSection = document.getElementById("address-section");
const btcAddressInput = document.getElementById("btc-address");
const btnCopyAddress = document.getElementById("btn-copy-address");

let wordCount = 12;
btn12.disabled = true;

// æ·»åŠ æŒ‰é’®ç‚¹å‡»æ³¢çº¹æ•ˆæœ
const addRippleEffect = (button) => {
  button.addEventListener('click', function(e) {
    if (this.disabled) return;

    const ripple = document.createElement('span');
    ripple.classList.add('ripple');
    this.appendChild(ripple);

    const rect = this.getBoundingClientRect();
    const size = Math.max(rect.width, rect.height);

    ripple.style.width = ripple.style.height = `${size}px`;
    ripple.style.left = `${e.clientX - rect.left - size/2}px`;
    ripple.style.top = `${e.clientY - rect.top - size/2}px`;

    ripple.classList.add('active');

    setTimeout(() => {
      ripple.remove();
    }, 600);
  });
};

// ä¸ºæ‰€æœ‰æŒ‰é’®æ·»åŠ æ³¢çº¹æ•ˆæœ
document.querySelectorAll('button').forEach(addRippleEffect);

// æ·»åŠ åŠ è½½åŠ¨ç”»
function showLoading(element) {
  element.classList.add('loading');
  element.setAttribute('data-text', element.textContent);
  element.textContent = 'å¤„ç†ä¸­...';
}

function hideLoading(element) {
  if (element.classList.contains('loading')) {
    element.textContent = element.getAttribute('data-text');
    element.classList.remove('loading');
  }
}

// è¯æ•°é€‰æ‹©
btn12.addEventListener("click", () => {
  wordCount = 12;
  btn12.disabled = true;
  btn24.disabled = false;
});

btn24.addEventListener("click", () => {
  wordCount = 24;
  btn12.disabled = false;
  btn24.disabled = true;
});

// ç”Ÿæˆå®‰å…¨çš„éšæœºç†µ
function generateEntropy(bytes) {
  if (bytes !== 16 && bytes !== 32) {
    throw new Error('ç†µé•¿åº¦å¿…é¡»æ˜¯16å­—èŠ‚ï¼ˆ12è¯ï¼‰æˆ–32å­—èŠ‚ï¼ˆ24è¯ï¼‰');
  }

  const arr = new Uint8Array(bytes);
  if (!cryptoObj || typeof cryptoObj.getRandomValues !== 'function') {
    throw new Error('å½“å‰ç¯å¢ƒä¸æ”¯æŒå®‰å…¨éšæœºæ•°ç”Ÿæˆ');
  }
  cryptoObj.getRandomValues(arr);

  return arr;
}

// å°†å­—èŠ‚æ•°ç»„è½¬æ¢ä¸ºä½æ•°ç»„
function bytesToBits(bytes) {
  const bits = [];
  for (let b of bytes) {
    for (let i = 7; i >= 0; i--) {
      bits.push((b >> i) & 1);
    }
  }
  return bits;
}

// å°†ä½æ•°ç»„è½¬æ¢ä¸ºæ•´æ•°
function bitsToInt(bits) {
  return bits.reduce((acc, b) => (acc << 1) | b, 0);
}

// BIP39: ä»ç†µç”ŸæˆåŠ©è®°è¯
async function entropyToMnemonic(entropy, wordlist) {
  if (!entropy || entropy.length === 0) {
    throw new Error('ç†µä¸èƒ½ä¸ºç©º');
  }
  if (!wordlist || wordlist.length !== 2048) {
    throw new Error('è¯è¡¨å¿…é¡»åŒ…å«2048ä¸ªå•è¯');
  }

  const ENT = entropy.length * 8;
  const checksumLen = ENT / 32;

  const hash = await sha256Bytes(entropy);

  const entropyBits = bytesToBits(entropy);
  const checksumBits = bytesToBits(hash).slice(0, checksumLen);
  const allBits = entropyBits.concat(checksumBits);

  const expectedBits = Math.floor((ENT + checksumLen) / 11) * 11;
  if (allBits.length !== expectedBits) {
    throw new Error(`ä½æ•°ç»„é•¿åº¦ä¸æ­£ç¡®: ${allBits.length}, æœŸæœ›: ${expectedBits}`);
  }

  const chunks = [];
  const wordCount = allBits.length / 11;

  for (let i = 0; i < wordCount; i++) {
    const start = i * 11;
    const end = start + 11;
    const wordIndex = bitsToInt(allBits.slice(start, end));

    if (wordIndex < 0 || wordIndex >= 2048) {
      throw new Error(`è¯è¡¨ç´¢å¼•è¶…å‡ºèŒƒå›´: ${wordIndex}`);
    }

    chunks.push(wordlist[wordIndex]);
  }

  return chunks.join(" ");
}

// è§„èŒƒåŒ–åŠ©è®°è¯
function normalizeMnemonic(mnemonic) {
  let normalized = mnemonic.trim();
  normalized = normalized.replace(/\s+/g, ' ');
  normalized = normalized.toLowerCase();
  normalized = normalized.normalize('NFKD');
  return normalized;
}

// BIP39: ä»åŠ©è®°è¯ç”Ÿæˆç§å­
async function mnemonicToSeed(mnemonic, passphrase = '') {
  const encoder = new TextEncoder();

  const normalizedMnemonic = normalizeMnemonic(mnemonic);
  const normalizedPassphrase = passphrase.normalize('NFKD');

  const mnemonicBytes = encoder.encode(normalizedMnemonic);
  const saltBytes = encoder.encode('mnemonic' + normalizedPassphrase);

  return pbkdf2HmacSha512(mnemonicBytes, saltBytes, 2048, 64);
}

// ç®€åŒ–çš„RIPEMD160å®ç°ï¼ˆç”¨äºæ¼”ç¤ºï¼‰
function ripemd160(bytes) {
  // åœ¨å®é™…å®ç°ä¸­ï¼Œè¿™é‡Œåº”è¯¥æ˜¯å®Œæ•´çš„RIPEMD160ç®—æ³•
  // ä¸ºäº†æ¼”ç¤ºï¼Œæˆ‘ä»¬ä½¿ç”¨SHA-256ä½œä¸ºæ›¿ä»£
  const hash = sha256Fallback(bytes);
  return hash.slice(0, 20);
}

// Bech32ç¼–ç ï¼ˆç®€åŒ–ç‰ˆï¼‰
function bech32EncodeWithVersion(hrp, data5bit) {
  const charset = 'qpzry9x8gf2tvdw0s3jn54khce6mua7l';

  // ç”Ÿæˆç®€å•çš„æ ¡éªŒå’Œï¼ˆç®€åŒ–ç‰ˆï¼‰
  let checksum = 0;
  for (let i = 0; i < data5bit.length; i++) {
    checksum ^= data5bit[i];
  }
  checksum &= 0x1f;

  const dataWithVersion = [0, ...data5bit, checksum];

  return hrp + '1' + dataWithVersion.map(i => charset[i]).join('');
}

// ç®€åŒ–çš„å‹ç¼©å…¬é’¥ç”Ÿæˆ
function privateKeyToCompressedPublicKey(privateKey) {
  // åœ¨å®é™…å®ç°ä¸­ï¼Œè¿™é‡Œåº”è¯¥æ˜¯å®Œæ•´çš„æ¤­åœ†æ›²çº¿ç®—æ³•
  // ä¸ºäº†æ¼”ç¤ºï¼Œæˆ‘ä»¬ç”Ÿæˆä¸€ä¸ªæ¨¡æ‹Ÿçš„å‹ç¼©å…¬é’¥
  const prefix = (privateKey[31] & 1) === 0 ? 0x02 : 0x03;
  const result = new Uint8Array(33);
  result[0] = prefix;
  result.set(privateKey, 1);
  return result;
}

// ç®€åŒ–çš„æ¯”ç‰¹å¸åœ°å€ç”Ÿæˆ
async function generateBitcoinAddress(mnemonic, passphrase = '') {
  try {
    // 1. ä»åŠ©è®°è¯ç”Ÿæˆç§å­
    const seed = await mnemonicToSeed(mnemonic, passphrase);

    // 2. ä»ç§å­ç”Ÿæˆç§é’¥ï¼ˆç®€åŒ–ç‰ˆï¼‰
    // åœ¨å®é™…å®ç°ä¸­ï¼Œè¿™é‡Œåº”è¯¥ä½¿ç”¨å®Œæ•´çš„BIP32æ´¾ç”Ÿ
    const privateKey = seed.slice(0, 32);

    // 3. ç”Ÿæˆå‹ç¼©å…¬é’¥
    const publicKey = privateKeyToCompressedPublicKey(privateKey);

    // 4. è®¡ç®—å…¬é’¥å“ˆå¸Œ
    const sha256Hash = await sha256Bytes(publicKey);
    const pubKeyHash = ripemd160(sha256Hash);

    // 5. è½¬æ¢ä¸º5ä½æ•°ç»„å¹¶ç¼–ç 
    const witnessVersion = 0;
    const data5bit = [];
    for (let i = 0; i < pubKeyHash.length; i++) {
      for (let j = 0; j < 8; j += 5) {
        if (i + j < pubKeyHash.length) {
          data5bit.push(pubKeyHash[i + j] >> 3 & 0x1f);
        }
      }
    }

    // 6. Bech32ç¼–ç 
    const address = bech32EncodeWithVersion('bc', data5bit);

    return address;
  } catch (error) {
    console.error('ç”Ÿæˆæ¯”ç‰¹å¸åœ°å€å¤±è´¥:', error);
    throw error;
  }
}

// ç”ŸæˆæŒ‰é’®äº‹ä»¶å¤„ç†
btnGenerate.addEventListener("click", async () => {
  showLoading(btnGenerate);
  mnemonicDiv.textContent = "";
  mnemonicDiv.classList.add('generating');

  // æ·»åŠ å»¶è¿Ÿä»¥æ˜¾ç¤ºåŠ¨ç”»æ•ˆæœ
  await new Promise(resolve => setTimeout(resolve, 500));

  try {
    // ç”Ÿæˆç†µ
    const entropy = generateEntropy(wordCount === 12 ? 16 : 32);

    // éªŒè¯ç†µä¸ä¸ºå…¨0
    const allZero = entropy.every(b => b === 0);
    if (allZero) {
      throw new Error('ç”Ÿæˆçš„ç†µä¸ºå…¨0ï¼Œè¯·é‡è¯•');
    }

    // ç”ŸæˆåŠ©è®°è¯
    const mnemonic = await entropyToMnemonic(entropy, EMBEDDED_BIP39_WORDLIST);

    // æ¸…é›¶ç†µï¼ˆå®‰å…¨æªæ–½ï¼‰
    for (let i = 0; i < entropy.length; i++) {
      entropy[i] = 0;
    }

    hideLoading(btnGenerate);
    mnemonicDiv.classList.remove('generating');

    // é€ä¸ªå•è¯æ˜¾ç¤ºåŠ¨ç”»
    const words = mnemonic.split(' ');
    mnemonicDiv.textContent = '';

    for (let i = 0; i < words.length; i++) {
      const wordSpan = document.createElement('span');
      wordSpan.textContent = words[i].toLowerCase();
      wordSpan.style.opacity = '0';
      wordSpan.style.transform = 'translateY(10px)';
      wordSpan.style.transition = `all 0.2s ease ${i * 50}ms`;

      mnemonicDiv.appendChild(wordSpan);

      setTimeout(() => {
        wordSpan.style.opacity = '1';
        wordSpan.style.transform = 'translateY(0)';
      }, 10);
    }

    // ç”Ÿæˆæ¯”ç‰¹å¸åœ°å€
    btcAddressInput.value = "è®¡ç®—ä¸­...";
    addressSection.style.display = 'block';

    try {
      const address = await generateBitcoinAddress(mnemonic, '');
      btcAddressInput.value = address;
    } catch (e) {
      console.error("ç”Ÿæˆæ¯”ç‰¹å¸åœ°å€å¤±è´¥:", e);
      btcAddressInput.value = "åœ°å€ç”Ÿæˆå¤±è´¥";
    }
  } catch (error) {
    hideLoading(btnGenerate);
    mnemonicDiv.classList.remove('generating');
    const errorMsg = error instanceof Error ? error.message : 'æœªçŸ¥é”™è¯¯';

    // æ˜¾ç¤ºå‹å¥½çš„é”™è¯¯æç¤º
    const errorDiv = document.createElement('div');
    errorDiv.style.cssText = `
      position: fixed;
      top: 20px;
      right: 20px;
      background: #ff6b6b;
      color: white;
      padding: 15px;
      border-radius: 5px;
      max-width: 300px;
      z-index: 9999;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    `;
    errorDiv.innerHTML = `<strong>ç”Ÿæˆå¤±è´¥ï¼š</strong>${errorMsg}`;
    document.body.appendChild(errorDiv);

    setTimeout(() => {
      if (errorDiv.parentNode) {
        errorDiv.parentNode.removeChild(errorDiv);
      }
    }, 5000);

    console.error("ç”ŸæˆåŠ©è®°è¯å¤±è´¥:", errorMsg);
    mnemonicDiv.textContent = "";
    btcAddressInput.value = "";
    addressSection.style.display = 'none';
  }
});

// æ¸…é™¤æŒ‰é’®äº‹ä»¶å¤„ç†
btnClear.addEventListener("click", () => {
  mnemonicDiv.textContent = "";
  btcAddressInput.value = "";
  addressSection.style.display = 'none';

  // æ·»åŠ æ¸…é™¤åŠ¨ç”»
  mnemonicDiv.classList.add('cleared');
  setTimeout(() => {
    mnemonicDiv.classList.remove('cleared');
  }, 500);
});

// å¤åˆ¶åœ°å€æŒ‰é’®åŠŸèƒ½
btnCopyAddress.addEventListener("click", async () => {
  const address = btcAddressInput.value.trim();
  if (!address || address === "è®¡ç®—ä¸­..." || address.startsWith("åœ°å€ç”Ÿæˆå¤±è´¥")) {
    return;
  }

  try {
    await navigator.clipboard.writeText(address);
    const originalText = btnCopyAddress.textContent;
    btnCopyAddress.textContent = "âœ“ å·²å¤åˆ¶";
    btnCopyAddress.style.background = "var(--success)";

    setTimeout(() => {
      btnCopyAddress.textContent = originalText;
      btnCopyAddress.style.background = "";
    }, 2000);
  } catch (e) {
    // é™çº§æ–¹æ¡ˆï¼šé€‰æ‹©æ–‡æœ¬
    btcAddressInput.select();
    btcAddressInput.setSelectionRange(0, 99999);
    try {
      document.execCommand('copy');
      const originalText = btnCopyAddress.textContent;
      btnCopyAddress.textContent = "âœ“ å·²å¤åˆ¶";
      setTimeout(() => {
        btnCopyAddress.textContent = originalText;
      }, 2000);
    } catch (err) {
      alert("å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨é€‰æ‹©å¤åˆ¶");
    }
  }
});

// ========== ä¸»é¢˜åˆ‡æ¢åŠŸèƒ½ ==========
const htmlElement = document.documentElement;
const themeToggle = document.getElementById('theme-toggle');
const sunIcon = document.getElementById('sun-icon');
const moonIcon = document.getElementById('moon-icon');

function getInitialTheme() {
  const saved = localStorage.getItem('theme');
  if (saved) return saved;
  if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
    return 'dark';
  }
  return 'light';
}

function setTheme(theme) {
  if (theme === 'dark') {
    htmlElement.setAttribute('data-theme', 'dark');
    sunIcon.style.display = 'block';
    moonIcon.style.display = 'none';
    localStorage.setItem('theme', 'dark');
  } else {
    htmlElement.removeAttribute('data-theme');
    sunIcon.style.display = 'none';
    moonIcon.style.display = 'block';
    localStorage.setItem('theme', 'light');
  }
}

// åˆå§‹åŒ–ä¸»é¢˜
setTheme(getInitialTheme());

// ä¸»é¢˜åˆ‡æ¢æŒ‰é’®ç‚¹å‡»äº‹ä»¶
themeToggle.addEventListener('click', () => {
  const currentTheme = htmlElement.getAttribute('data-theme');
  setTheme(currentTheme === 'dark' ? 'light' : 'dark');
});

// ç›‘å¬ç³»ç»Ÿä¸»é¢˜å˜åŒ–
if (window.matchMedia) {
  window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
    if (!localStorage.getItem('theme')) {
      setTheme(e.matches ? 'dark' : 'light');
    }
  });
}

// é¡µé¢åŠ è½½å®ŒæˆåŠ¨ç”»
document.addEventListener('DOMContentLoaded', () => {
  document.body.classList.add('loaded');
});

console.log('ğŸ”’ å®Œæ•´ä¿®å¤ç‰ˆå·²åŠ è½½å®Œæˆï¼Œæ‰€æœ‰äº¤äº’åŠŸèƒ½å·²ä¿®å¤');
</script>

</body>
</html>